# Ralph Progress Log
Started: Mon  2 Feb 2026 15:30:58 GMT
---

## Codebase Patterns
- For non-tRPC events (webhooks), use `outboxClient.sendTx(getDb(), eventName, async (_tx) => ({ payload }))` to enqueue and let consumers handle side effects.
- For tRPC routers emitting outbox events, use `outbox/internal-client.ts` with shared `outbox/event-types.ts` to avoid appRouter type cycles.
- For machine promotion side effects, emit `machine:promoted` via `internalOutboxClient.sendTx` and pass archived machine info so consumers can archive providers asynchronously.
- For OAuth callbacks, enqueue `connection:*:created` with connection metadata and let consumers provision secrets + poke machines.
- For checkout flows needing async external calls, store result fields on `outbox_event.payload` and poll via a tRPC status query.

## 2026-02-02 15:46:57 GMT - US-001
- Ported outbox infra (pgmq library, queuer, client, consumers, type tests) and wired consumer registration on worker startup
- Files changed: apps/os/backend/outbox/*, apps/os/backend/trpc/trpc.ts, apps/os/backend/worker.ts, apps/os/backend/db/schema.ts, apps/os/backend/db/migrations/0013_outbox_event.sql, apps/os/backend/db/migrations/0014_pgmq.sql, apps/os/backend/db/migrations/0015_consumer_job_queue.sql, ralph-outbox.ignoreme/prd.json
- **Learnings for future iterations:**
  - Patterns discovered: outbox consumers register via `registerConsumers()` and can be wired early in `apps/os/backend/worker.ts`
  - Gotchas encountered: `tag-logger` lacks `logger.run`; use direct calls in outbox lib
  - Useful context: pgmq queue setup requires both schema migration and `pgmq.create('consumer_job_queue')`
---

## 2026-02-02 15:54:20 GMT - US-002
- Moved Stripe webhook side effects to outbox consumers and enqueue events after verification
- Files changed: apps/os/backend/integrations/stripe/webhook.ts, apps/os/backend/integrations/stripe/stripe-outbox.ts, apps/os/backend/outbox/consumers.ts, apps/os/backend/outbox/client.ts, ralph-outbox.ignoreme/prd.json, ralph-outbox.ignoreme/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: Stripe webhook consumers can reuse existing billing handlers with `env` from `apps/os/env.ts`
  - Gotchas encountered: `sendTx` callbacks must return a Promise (use `async`)
  - Useful context: keep webhook handlers minimal; emit per-event outbox names for clarity
---

## 2026-02-02 16:02:18 GMT - US-003
- Moved Slack webhook + interactive handling to outbox consumers and enqueue raw events
- Files changed: apps/os/backend/integrations/slack/slack.ts, apps/os/backend/integrations/slack/slack-outbox.ts, apps/os/backend/outbox/client.ts, apps/os/backend/outbox/consumers.ts, ralph-outbox.ignoreme/prd.json, ralph-outbox.ignoreme/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: share Slack team + active machine lookup across webhook/interactive consumers
  - Gotchas encountered: update outbox client event types before calling `sendTx`
  - Useful context: webhook handlers should enqueue and return after signature checks
---

## 2026-02-02 16:07:42 GMT - US-004
- Moved Resend webhook handling to outbox consumer and enqueue raw events after validation
- Files changed: apps/os/backend/integrations/resend/resend.ts, apps/os/backend/integrations/resend/resend-outbox.ts, apps/os/backend/outbox/client.ts, apps/os/backend/outbox/consumers.ts, ralph-outbox.ignoreme/prd.json, ralph-outbox.ignoreme/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: keep stage-forwarding logic in webhook handlers, move side effects to outbox consumers
  - Gotchas encountered: add outbox event types before enqueueing
  - Useful context: reuse existing email forwarding helpers inside consumer to keep handler minimal
---

## 2026-02-02 17:12:04 GMT - US-005
- Moved machine provisioning to outbox consumer with machine:created enqueue and PostHog tracking
- Files changed: apps/os/backend/trpc/routers/machine.ts, apps/os/backend/outbox/consumers.ts, apps/os/backend/outbox/client.ts, apps/os/backend/outbox/internal-client.ts, apps/os/backend/outbox/event-types.ts, apps/os/backend/machines/machine-outbox.ts, apps/os/backend/machines/machine-token.ts, apps/os/backend/trpc/routers/access-token.ts, ralph-outbox.ignoreme/prd.json, ralph-outbox.ignoreme/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: split outbox event types into `outbox/event-types.ts` for reuse across internal clients
  - Gotchas encountered: avoid importing `outboxClient` inside appRouter modules to prevent type cycles
  - Useful context: placeholder machine externalId can be updated after provisioning completes
---

## 2026-02-02 16:29:17 GMT - US-006
- Emitted machine:promoted from daemon reportStatus flow and moved provider archival to outbox consumer
- Files changed: apps/os/backend/orpc/router.ts, apps/os/backend/outbox/consumers.ts, apps/os/backend/outbox/event-types.ts, apps/os/backend/machines/machine-outbox.ts, ralph-outbox.ignoreme/prd.json, ralph-outbox.ignoreme/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: include archived machine provider details in outbox payloads to avoid follow-up DB reads
  - Gotchas encountered: use `internalOutboxClient.sendTx` in non-tRPC paths to keep promotion updates and enqueue atomic
  - Useful context: provider archiving should run in consumers to keep daemon handlers fast and retryable
---

## 2026-02-02 16:40:12 GMT - US-007
- Emitted OAuth connection outbox events and moved secret provisioning + machine refresh to consumers
- Files changed: apps/os/backend/integrations/github/github.ts, apps/os/backend/integrations/google/google.ts, apps/os/backend/integrations/slack/slack.ts, apps/os/backend/integrations/oauth-outbox.ts, apps/os/backend/outbox/consumers.ts, apps/os/backend/outbox/event-types.ts, ralph-outbox.ignoreme/prd.json, ralph-outbox.ignoreme/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: keep OAuth handlers focused on connection writes and enqueue follow-up provisioning
  - Gotchas encountered: include encrypted tokens in outbox payloads when consumer needs secret material
  - Useful context: consumer names should describe side effects, not event names
---

## 2026-02-02 16:58:12 GMT - US-008
- Queued billing checkout initiation via outbox and added polling status query for checkout URL
- Files changed: apps/os/backend/trpc/routers/billing.ts, apps/os/backend/billing/billing-outbox.ts, apps/os/backend/outbox/event-types.ts, apps/os/backend/outbox/consumers.ts, apps/os/app/routes/org/billing.tsx, ralph-outbox.ignoreme/prd.json, ralph-outbox.ignoreme/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered: store async checkout results in outbox_event payload and poll via tRPC
  - Gotchas encountered: trpc queryOptions doesn't accept onSuccess/onError; use useEffect for redirect/toast
  - Useful context: internalOutboxClient.send returns eventId for polling
---

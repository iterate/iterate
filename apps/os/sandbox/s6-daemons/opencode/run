#!/bin/sh
exec 2>&1

ENV_FILE="$HOME/.iterate/.env"

# Source env vars written by bootstrap (API keys, etc.)
[ -f "$ENV_FILE" ] && set -a && . "$ENV_FILE" && set +a

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PORT=$(node -p "require('$SCRIPT_DIR/metadata.json').port")

# Change to customer repo directory if set, otherwise fall back to home.
# ITERATE_CUSTOMER_REPO_PATH is set by bootstrap when a customer repo is configured.
# This ensures opencode loads AGENTS.md from the customer's repo.
if [ -n "$ITERATE_CUSTOMER_REPO_PATH" ]; then
  # Expand ~ to $HOME
  REPO_PATH=$(echo "$ITERATE_CUSTOMER_REPO_PATH" | sed "s|^~|$HOME|")
  if [ -d "$REPO_PATH" ]; then
    cd "$REPO_PATH"
  else
    echo "Warning: ITERATE_CUSTOMER_REPO_PATH=$REPO_PATH does not exist, using HOME"
    cd "$HOME"
  fi
else
  cd "$HOME"
fi

echo "Starting opencode server in $(pwd)"

# Use tini to forward signals to entire process group and reap zombies
# -s: subreaper mode (catches orphaned processes)
# -g: kills entire process group on SIGTERM
exec tini -sg -- opencode serve --port "$PORT" --hostname 0.0.0.0 --log-level DEBUG

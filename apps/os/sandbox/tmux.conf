# tmux configuration for iterate sandbox
#
# Key features:
# - tmux-resurrect for session persistence across restarts
# - Hooks to sync session state to SQLite database
#
# The sync flow is one-directional:
#   tRPC mutation -> tmux command -> tmux hook -> sync script -> SQLite

# =============================================================================
# DEFAULTS
# =============================================================================

set -g history-limit 50000
set -g mouse on

# =============================================================================
# TMUX-RESURRECT
# =============================================================================
#
# tmux-resurrect saves and restores tmux sessions across server restarts.
# - Manual save: prefix + Ctrl-s
# - Manual restore: prefix + Ctrl-r
# - Save location: ~/.tmux/resurrect/
#
# The daemon also triggers save programmatically after session changes.

run-shell ~/.tmux/plugins/tmux-resurrect/resurrect.tmux

# Capture pane contents when saving (scrollback history)
set -g @resurrect-capture-pane-contents 'on'

# =============================================================================
# SYNC HOOKS
# =============================================================================
#
# These hooks call a standalone TypeScript script that updates the SQLite
# database whenever tmux sessions change. This keeps the DB in sync with
# tmux as the source of truth.
#
# Note: session-closed hook cannot access session name (fires after data
# destroyed), so the sync script does a full reconciliation.

# Log errors to a file instead of suppressing them
set-hook -g session-created 'run-shell -b "tsx /root/src/github.com/iterate/iterate/apps/daemon/scripts/sync-sessions.ts 2>> /tmp/sync-sessions.log"'
set-hook -g session-closed 'run-shell -b "tsx /root/src/github.com/iterate/iterate/apps/daemon/scripts/sync-sessions.ts 2>> /tmp/sync-sessions.log"'
set-hook -g session-renamed 'run-shell -b "tsx /root/src/github.com/iterate/iterate/apps/daemon/scripts/sync-sessions.ts 2>> /tmp/sync-sessions.log"'

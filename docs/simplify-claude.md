# OS2 Simplification Analysis

**Generated by:** Claude analysis agents
**Date:** 2026-01-06
**Scope:** apps/os2 compared to docs/spec/001-shell.md

## Executive Summary

The os2 app is ~6,500 lines of TypeScript. While this is ~6% of the original os backend (45,362 lines), several areas still exceed what the shell spec requires. This document identifies **~1,500+ lines** that could be removed or simplified while maintaining full spec compliance.

### Key Themes

1. **Naming mismatch**: Code uses "instance" where spec uses "project"
2. **Missing spec tables**: 4 required tables are not implemented
3. **Premature features**: WebSocket DO, Slack signature verification, OAuth integration flows
4. **Dead code**: Unused helper functions, stub endpoints, over-engineered middleware
5. **Auth complexity**: Service auth backdoor, Slack bot login flow that shouldn't exist

---

## Priority 1: Critical Issues (Do First)

### 1.1 Rename Instance → Project

**Impact:** High (touches entire codebase)
**Effort:** Medium (find/replace + migration)

The spec defines "Project" as the primary domain entity (one-to-one with repo). The code uses "Instance" everywhere.

| Current                   | Spec                     |
| ------------------------- | ------------------------ |
| `instance` table          | `project` table          |
| `inst_` ID prefix         | `prj_` ID prefix         |
| `instanceId` foreign keys | `projectId` foreign keys |
| `instanceRouter`          | `projectRouter`          |
| `instanceSlug` param      | `projectSlug` param      |

**Files to change:**

- `backend/db/schema.ts` (lines 165-187)
- `backend/trpc/routers/instance.ts` (rename file)
- `backend/trpc/trpc.ts` (instanceProtectedProcedure → projectProtectedProcedure)
- All routes using `instanceSlug` parameter
- Frontend sidebar, layouts

### 1.2 Add Missing Schema Tables

**Impact:** High (blocks feature implementation)
**Effort:** Medium

The spec requires these tables which are completely missing:

| Table                  | Prefix  | Purpose                          |
| ---------------------- | ------- | -------------------------------- |
| `project_env_var`      | `env_`  | Encrypted environment variables  |
| `project_access_token` | `pat_`  | API access tokens with hashing   |
| `project_connection`   | `conn_` | OAuth integrations (Slack/Gmail) |

The current `instanceAccountPermission` table should be replaced by `project_connection`.

**Schema additions needed (from spec lines 165-207):**

```typescript
// project_env_var
export const projectEnvVar = pgTable(
  "project_env_var",
  (t) => ({
    id: iterateId("env"),
    projectId: t
      .text()
      .notNull()
      .references(() => project.id, { onDelete: "cascade" }),
    key: t.text().notNull(),
    encryptedValue: t.text().notNull(),
    ...withTimestamps,
  }),
  (t) => [uniqueIndex().on(t.projectId, t.key)],
);

// project_access_token
export const projectAccessToken = pgTable("project_access_token", (t) => ({
  id: iterateId("pat"),
  projectId: t
    .text()
    .notNull()
    .references(() => project.id, { onDelete: "cascade" }),
  name: t.text().notNull(),
  tokenHash: t.text().notNull(),
  lastUsedAt: t.timestamp(),
  revokedAt: t.timestamp(),
  ...withTimestamps,
}));

// project_connection
export const projectConnection = pgTable(
  "project_connection",
  (t) => ({
    id: iterateId("conn"),
    projectId: t
      .text()
      .notNull()
      .references(() => project.id, { onDelete: "cascade" }),
    provider: t.text().notNull(), // 'slack' | 'google'
    externalId: t.text().notNull(), // Slack team ID, Google account ID
    scope: t.text({ enum: ["project", "user"] }).notNull(),
    userId: t.text().references(() => user.id, { onDelete: "cascade" }),
    providerData: t.jsonb().$type<Record<string, unknown>>().notNull().default({}),
    scopes: t.text(),
    ...withTimestamps,
  }),
  (t) => [uniqueIndex().on(t.provider, t.externalId)],
);
```

### 1.3 Fix Repo Table Structure

**Impact:** Medium
**Effort:** Low

Current repo table diverges from spec:

| Current          | Spec Required                 |
| ---------------- | ----------------------------- |
| `accountId`      | `owner` (repo owner/org name) |
| `repoId` integer | `name` (repo name)            |
| `branch`         | `defaultBranch`               |
| `deactivatedAt`  | Not needed                    |

**Fix:** Rewrite to match spec (lines 140-150).

### 1.4 Fix Event Table

**Impact:** Medium
**Effort:** Low

Current issues:

- References `instanceId` not `projectId`
- Foreign key is NOT NULL (spec allows NULL for unrecognized webhooks)
- Includes `updatedAt` (spec only has `createdAt`)

**Fix:**

```typescript
export const event = pgTable(
  "event",
  (t) => ({
    id: iterateId("evt"),
    projectId: t.text().references(() => project.id, { onDelete: "cascade" }), // Nullable!
    type: t.text().notNull(),
    payload: t.jsonb().$type<Record<string, unknown>>().notNull(),
    createdAt: timestamp().defaultNow().notNull(),
  }),
  (t) => [index().on(t.projectId), index().on(t.type), index().on(t.createdAt)],
);
```

---

## Priority 2: Remove Dead/Unused Code

### 2.1 Delete Service Auth Plugin

**File:** `backend/auth/service-auth.ts`
**Lines:** 45 lines
**Issue:** Creates undocumented backdoor for admin-npc@nustom.com user. Never called from anywhere.

**Security risk:** Allows arbitrary session creation without audit trail.

**Action:** Delete entire file and remove registration from `auth.ts` line 27.

### 2.2 Delete Slack Bot OAuth Flow

**File:** `backend/auth/integrations.ts`
**Lines:** ~250 lines
**Issue:** Implements Slack as a login mechanism (creates users/orgs on first Slack login). Spec says login is email OTP + Google OAuth only.

**Action:** Delete:

- `linkSlackBot` endpoint (lines 57-131)
- `callbackSlackBot` endpoint (lines 186-395)
- `SLACK_BOT_SCOPES`, `SLACK_USER_AUTH_SCOPES` constants (lines 17-51)

### 2.3 Delete Unused tRPC Helpers

**File:** `backend/trpc/trpc.ts`
**Lines:** ~60 lines

Delete these never-called functions:

- `getUserOrganizations()` (lines 99-115)
- `getUserOrganizationAccess()` (lines 117-135)
- `getUserInstanceAccess()` (lines 137-156)
- `autoInvalidateMiddleware` (lines 72-81, commented as no-op)

### 2.4 Remove Organization Delete Mutation

**File:** `backend/trpc/routers/organization.ts`
**Lines:** 13 lines (204-216)

Spec has no UI for org deletion. Remove to reduce attack surface.

### 2.5 Remove Machine Unarchive Mutation

**File:** `backend/trpc/routers/machine.ts`
**Lines:** 27 lines (114-140)

Spec only mentions archiving machines, not un-archiving. Frontend never calls this.

### 2.6 Remove "Can't Delete Last Instance" Check

**File:** `backend/trpc/routers/instance.ts`
**Lines:** 11 lines (74-84)

Arbitrary constraint not in spec. Let users delete projects if they want.

---

## Priority 3: Remove Premature Features

### 3.1 Delete WebSocket Durable Object

**Impact:** Reduces operational complexity
**Lines:** ~330 lines total

The spec explicitly excludes real-time collaboration (line 34). The WebSocket DO is fully implemented but the frontend has zero usage.

**Files to delete:**

- `backend/durable-objects/organization-websocket.ts` (258 lines)
- Remove DO bindings from wrangler config
- Remove WebSocket route from `worker.ts` (lines 98-112)
- Remove DO class export from `worker.ts` (line 150)

### 3.2 Simplify Slack Integration

**Current:** Full signature verification + interactive/commands stubs
**Spec says:** "Skip signature verification for now" (line 308)

**File:** `backend/integrations/slack/slack.ts`, `slack-utils.ts`
**Lines saved:** ~120 lines

**Remove:**

- Signature verification function and call
- `/interactive` POST handler (lines 103-137)
- `/commands` POST handler (lines 142-169)

**Keep:** Basic webhook handler that stores events with projectId (nullable).

### 3.3 Remove Google Integration Endpoints

**File:** `backend/auth/integrations.ts`
**Lines:** ~110 lines

The `linkGoogle` and `callbackGoogle` endpoints exist but:

- Frontend never calls them (connectors page has console.log stubs)
- Spec separates Google login (auth layer) from Gmail integration (project connection)

**Action:** Delete lines 133-184 (linkGoogle) and 397-505 (callbackGoogle).

---

## Priority 4: Auth Layer Cleanup

### 4.1 Simplify OAuth State Schemas

**File:** `backend/auth/oauth-state-schemas.ts`
**Lines:** 15 lines removable

`SlackBotOAuthState` and `BaseOAuthState` are only used for Slack bot flow (being removed).

Keep only minimal `GoogleOAuthState` for login flow.

### 4.2 Remove Stub Impersonation Endpoints

**File:** `backend/trpc/routers/admin.ts`
**Lines:** ~35 lines (8-41)

`impersonate` and `stopImpersonating` are documented as "would be handled via better-auth admin plugin" but aren't actually functional.

Either implement properly or remove stubs.

### 4.3 Gate Testing Router Behind NODE_ENV

**File:** `backend/trpc/routers/testing.ts`

**Security issue:** `createTestUser` and `cleanupTestData` are public procedures that can create admin users or delete data.

**Action:** Add environment check or remove router registration in production.

---

## Priority 5: Frontend Simplification

### 5.1 Remove Stub Routes

The connectors page (`/org/project/connectors.tsx`) has non-functional buttons:

```typescript
const handleSlackConnect = () => {
  console.log("Connect Slack"); // Does nothing
};
```

**Action:** Either implement or remove until backend supports it.

### 5.2 Extract Reusable Patterns

**Loading state** (repeated 3+ times):

```tsx
if (isLoading) {
  return (
    <div className="flex items-center justify-center py-8">
      <div className="text-muted-foreground">Loading...</div>
    </div>
  );
}
```

Create `<LoadingState />` component.

**Mutation toast pattern** (repeated in all forms):

```tsx
onSuccess: () => {
  queryClient.invalidateQueries(...);
  toast.success("...");
},
onError: (error) => {
  toast.error("Failed: " + error.message);
},
```

Create `useMutationWithToast()` hook.

### 5.3 Simplify Admin Area

- Admin layout has its own sidebar (duplicate of main sidebar pattern)
- Dashboard shows basic counts with excessive markup
- Could reduce from ~150 lines to ~50 lines

---

## Priority 6: Minor Improvements

### 6.1 Fix Badge Color Variants

**File:** `app/components/ui/badge.tsx`

Uses hardcoded `green-500`, `yellow-500` instead of theme tokens. Update to use semantic colors.

### 6.2 Standardize Logging

**File:** `backend/worker.ts`

Uses `console.log` but repo rules require `logger` from tag-logger.ts. Either:

- Create `backend/tag-logger.ts` for os2
- Import shared logging utility

### 6.3 Document Environment Fallbacks

**File:** `env.ts`

The conditional import of `cloudflare:workers` handles test environments but lacks explaining comments.

---

## Summary: Estimated Impact

| Category                       | Lines Removed | Complexity Reduction  |
| ------------------------------ | ------------- | --------------------- |
| Dead code (helpers, stubs)     | ~200          | Medium                |
| Service auth + Slack bot login | ~300          | High (security)       |
| WebSocket DO                   | ~330          | High (ops complexity) |
| Slack verification + stubs     | ~120          | Medium                |
| Google integration endpoints   | ~110          | Medium                |
| Admin impersonation stubs      | ~35           | Low                   |
| Frontend stub routes           | ~50           | Low                   |
| **Total**                      | **~1,145**    | **Significant**       |

**Additional schema work:**

- Add 3 missing tables (~80 lines)
- Rename instance → project (migration + refactor)
- Fix repo/event tables (~30 lines changed)

---

## Implementation Order

### Phase 1: Safety & Dead Code (Day 1)

1. Delete `service-auth.ts`
2. Delete Slack bot OAuth flow from integrations.ts
3. Delete unused tRPC helpers
4. Gate testing router behind NODE_ENV

### Phase 2: Schema Alignment (Day 1-2)

1. Rename instance → project
2. Add missing tables (env vars, tokens, connections)
3. Fix repo table structure
4. Fix event table (nullable projectId)

### Phase 3: Premature Features (Day 2)

1. Delete WebSocket Durable Object
2. Simplify Slack integration
3. Remove Google integration endpoints
4. Remove stub admin endpoints

### Phase 4: Polish (Day 3)

1. Frontend loading/mutation patterns
2. Badge color fixes
3. Logging standardization
4. Remove/fix stub routes

---

## What NOT to Change

These are correctly minimal and should stay:

- **Infrastructure configs** (vite, drizzle, vitest, alchemy) - already right-sized
- **UI component count** (8 shadcn components) - appropriate for shell
- **Worker setup** - clean middleware composition
- **Basic auth flow** (email OTP + Google OAuth) - spec-compliant
- **Machine CRUD** - fully functional and spec-aligned

---

## Appendix: File-by-File Deletion Map

```
backend/auth/
  service-auth.ts                    DELETE (45 lines)
  integrations.ts                    DELETE lines 17-51, 57-131, 186-505 (~350 lines)
  oauth-state-schemas.ts             DELETE lines 3-15 (15 lines)

backend/trpc/
  trpc.ts                           DELETE lines 72-81, 99-156 (~65 lines)
  routers/organization.ts           DELETE lines 204-216 (13 lines)
  routers/instance.ts               DELETE lines 74-84, rename file (11 lines)
  routers/machine.ts                DELETE lines 114-140 (27 lines)
  routers/admin.ts                  DELETE lines 8-41 (35 lines)
  routers/testing.ts                ADD env check or gate registration

backend/durable-objects/
  organization-websocket.ts         DELETE (258 lines)

backend/integrations/slack/
  slack.ts                          DELETE lines 18-29, 103-169 (~78 lines)
  slack-utils.ts                    DELETE verifySlackSignature (~40 lines)

backend/db/
  schema.ts                         FIX instance→project, add tables, fix repo/event
```

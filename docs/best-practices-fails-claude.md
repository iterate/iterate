# Best Practices Analysis: apps/os2 Codebase

> Generated by Claude on 2026-01-06 after thorough research of current documentation for all major technologies used.

This document identifies situations where the `apps/os2` codebase is not in accordance with recommended best practices for the technologies it uses.

---

## Table of Contents

1. [Critical Issues](#critical-issues)
2. [TanStack Router](#tanstack-router)
3. [TanStack Query](#tanstack-query)
4. [tRPC v11](#trpc-v11)
5. [React 19](#react-19)
6. [Drizzle ORM](#drizzle-orm)
7. [Better-Auth](#better-auth)
8. [Hono](#hono)
9. [Zod v4](#zod-v4)
10. [Cloudflare Workers](#cloudflare-workers)
11. [Vite & Tailwind CSS v4](#vite--tailwind-css-v4)
12. [Summary & Prioritized Action Items](#summary--prioritized-action-items)

---

## Critical Issues

These issues **violate the codebase's own documented rules** (CLAUDE.md/vibe-rules):

### 1. ‚ö†Ô∏è Using `useQuery` Instead of `useSuspenseQuery`

**Rule Violation:** `vibe-rules/rules/trpc-and-tanstack-query-usage.md` explicitly states:
> "Prefer the useSuspenseQuery hook when making trpc queries. We want to use <Suspense> and <ErrorBoundary> in sensible places."

**Current State:** All 16+ route components use `useQuery()` with manual loading states instead of `useSuspenseQuery()`.

**Files Affected:**
- `apps/os2/app/routes/index.tsx`
- `apps/os2/app/routes/org/layout.tsx`
- `apps/os2/app/routes/org/index.tsx`
- `apps/os2/app/routes/org/settings.tsx`
- `apps/os2/app/routes/org/team.tsx`
- `apps/os2/app/routes/org/project/layout.tsx`
- `apps/os2/app/routes/org/project/index.tsx`
- `apps/os2/app/routes/user/settings.tsx`
- `apps/os2/app/routes/auth-required.layout.tsx`
- `apps/os2/app/routes/login.tsx`
- And more...

**Example of Current Anti-Pattern:**
```tsx
// apps/os2/app/routes/org/layout.tsx
const { data: organizations, isPending: orgsPending } = useQuery(
  trpc.user.myOrganizations.queryOptions(),
);

if (orgsPending || orgPending || !user) {
  return (
    <div className="flex min-h-screen items-center justify-center">
      <div className="text-muted-foreground">Loading...</div>
    </div>
  );
}
```

**Should Be:**
```tsx
const { data: organizations } = useSuspenseQuery(
  trpc.user.myOrganizations.queryOptions(),
);
// No loading check needed - Suspense boundary handles it
```

### 2. ‚ö†Ô∏è Zod Import Path Discrepancy

**Rule Violation:** `CLAUDE.md` states:
> "Use import { z } from 'zod/v4' to import v4 of zod (the latest version), do not use import ... from 'zod' without the /v4"

**Current State:** All files import from `"zod"` directly:
```typescript
// apps/os2/backend/trpc/trpc.ts:1
import { prettifyError, z, ZodError } from "zod";

// apps/os2/backend/trpc/routers/organization.ts:1
import { z } from "zod";
```

**Analysis:** The CLAUDE.md rule appears outdated. Since the codebase uses Zod v4.1.12 exclusively, importing from `"zod"` is correct. The `/v4` subpath was only needed during the v3‚Üív4 transition or when v5+ is installed alongside v4.

**Recommendation:** Update the rule in `vibe-rules/rules/typescript.md` to reflect that `"zod/v4"` is only needed when multiple Zod versions are installed.

---

## TanStack Router

**Version:** 1.139.12

### Issues Found

#### 1. No Route Loaders for Data Fetching

**Best Practice:** TanStack Router v1.139+ recommends using route `loader` functions for data that needs to load before route renders.

**Current Pattern:** Data fetching happens in component render via `useQuery()`.

**Recommended Pattern:**
```typescript
export const Route = createFileRoute("/_auth-required.layout/_/$organizationSlug")({
  loader: async ({ params, context }) => {
    const [organizations, currentOrg] = await Promise.all([
      context.queryClient.ensureQueryData(
        trpc.user.myOrganizations.queryOptions()
      ),
      context.queryClient.ensureQueryData(
        trpc.organization.withInstances.queryOptions({
          organizationSlug: params.organizationSlug,
        })
      ),
    ]);
    return { organizations, currentOrg };
  },
  component: OrgLayout,
});

function OrgLayout() {
  const { organizations, currentOrg } = Route.useLoaderData();
  // Data is guaranteed - no loading states needed
}
```

**Benefits:**
- Enables SSR data fetching
- Enables prefetching on hover/intent
- Eliminates loading waterfalls
- Better type safety

#### 2. No `beforeLoad` for Authentication

**Best Practice:** Use `beforeLoad` for auth checks - prevents rendering unauthorized routes.

**Current Pattern:**
```tsx
// apps/os2/app/routes/auth-required.layout.tsx
function AuthRequiredLayout() {
  const { isAuthenticated, isLoading } = useSessionUser();

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" />;  // ‚ùå Renders component first
  }

  return <Outlet />;
}
```

**Recommended Pattern:**
```typescript
export const Route = createFileRoute("/_auth-required.layout")({
  beforeLoad: async ({ context }) => {
    const session = await context.queryClient.ensureQueryData(sessionQueryOptions);
    if (!session?.user) {
      throw redirect({ to: "/login" });  // ‚úÖ Redirects before render
    }
    return { session };
  },
  component: AuthRequiredLayout,
});
```

#### 3. Using `<Navigate>` Instead of `throw redirect()`

**Best Practice:** Use `throw redirect()` from loaders/beforeLoad for better performance.

**Files Using `<Navigate>`:**
- `apps/os2/app/routes/index.tsx`
- `apps/os2/app/routes/org/layout.tsx`
- `apps/os2/app/routes/auth-required.layout.tsx`
- `apps/os2/app/routes/login.tsx`

#### 4. QueryClient Not Passed to Router Context

**Current State:**
```typescript
// apps/os2/app/router.tsx
export function getRouter() {
  const router = createRouter({
    routeTree,
    scrollRestoration: true,
    search: { strict: false },
    // ‚ùå Missing context
  });
  return router;
}
```

**Recommended:**
```typescript
export function getRouter(queryClient: QueryClient) {
  const router = createRouter({
    routeTree,
    context: { queryClient },  // ‚úÖ Enables loaders to use QueryClient
    scrollRestoration: true,
    search: { strict: false },
  });
  return router;
}
```

---

## TanStack Query

**Version:** 5.90.11

### Issues Found

#### 1. No Suspense Boundaries

**Best Practice:** Wrap route sections in `<Suspense>` boundaries.

**Current State:** Zero `<Suspense>` components in the app. No `wrapInSuspense: true` on routes.

**Recommended:**
```tsx
// apps/os2/app/routes/root.tsx
export const Route = createRootRoute({
  component: RootComponent,
  wrapInSuspense: true,  // ‚úÖ Add this
});

// Or in layout components
<Suspense fallback={<LoadingSpinner />}>
  <Outlet />
</Suspense>
```

#### 2. No Error Boundaries

**Best Practice:** React Query errors should be caught by ErrorBoundary components.

**Current State:** No ErrorBoundary components anywhere. Manual error handling or errors ignored.

**Recommended:**
```tsx
// apps/os2/app/routes/root.tsx
<QueryClientProvider client={queryClient}>
  <ErrorBoundary fallback={<ErrorPage />}>
    <Outlet />
  </ErrorBoundary>
</QueryClientProvider>
```

#### 3. QueryClient Singleton at Module Level

**Issue:** QueryClient created at module scope is problematic for SSR.

**Current:**
```typescript
// apps/os2/app/routes/root.tsx
const queryClient = new QueryClient({...});  // ‚ùå Module-level singleton
```

**Recommended:**
```typescript
let browserQueryClient: QueryClient | undefined = undefined;

function getQueryClient() {
  if (typeof window === 'undefined') {
    return new QueryClient({...});  // New instance for SSR
  }
  if (!browserQueryClient) {
    browserQueryClient = new QueryClient({...});
  }
  return browserQueryClient;
}
```

#### 4. Missing QueryClient Configuration

**Current:**
```typescript
defaultOptions: {
  queries: {
    staleTime: 1000 * 60,
    refetchOnWindowFocus: false,
  },
}
```

**Recommended additions:**
```typescript
defaultOptions: {
  queries: {
    staleTime: 60 * 1000,
    gcTime: 5 * 60 * 1000,  // Garbage collection time
    retry: 1,               // Retry failed queries once
    refetchOnWindowFocus: false,
    refetchOnMount: true,
    refetchOnReconnect: true,
  },
  mutations: {
    retry: 0,  // Don't retry mutations
  },
}
```

#### 5. Hardcoded Query Key Invalidations

**Issue:** Some files use hardcoded strings instead of tRPC query keys.

**Current:**
```typescript
// apps/os2/app/routes/org/settings.tsx
queryClient.invalidateQueries({ queryKey: ["organization"] });
queryClient.invalidateQueries({ queryKey: ["user", "myOrganizations"] });
```

**Recommended:**
```typescript
queryClient.invalidateQueries({
  queryKey: trpc.organization.bySlug.queryKey({ organizationSlug })
});
```

---

## tRPC v11

**Version:** 11.7.2

### Issues Found

#### 1. Missing `maxURLLength` on httpBatchLink

**Issue:** Large GET requests can exceed URL limits.

**Current:**
```typescript
// apps/os2/app/lib/trpc.ts
httpBatchLink({
  url: "/api/trpc",
  transformer: superjson,
  // ‚ùå Missing maxURLLength
})
```

**Recommended:**
```typescript
httpBatchLink({
  url: "/api/trpc",
  transformer: superjson,
  maxURLLength: 2083,  // Auto-switch to POST when URLs exceed limit
})
```

#### 2. Consider Using `createTRPCContext` Pattern

**Current:** Using `createTRPCOptionsProxy` pattern.

**Recommended for TanStack Start:** The `createTRPCContext` pattern (used in apps/os) provides better integration with SSR and the router context.

---

## React 19

**Version:** 19.2.0

### Issues Found

#### 1. Not Using React 19 Features

**Missing Features:**
- No `<Suspense>` boundaries (critical for React 19)
- No Error boundaries
- No `useTransition` for non-urgent updates
- No `startTransition` for navigation
- Not using `use()` hook where appropriate

#### 2. Manual Loading States Everywhere

**Anti-Pattern:**
```tsx
if (isLoading) {
  return <div>Loading...</div>;
}
```

React 19 is designed around Suspense for async operations. Manual loading states defeat concurrent rendering benefits.

#### 3. Not Using Server Components (Design Decision)

**Current:** All components are client-side rendered.

**Note:** This is a valid design decision for an authenticated dashboard with real-time features. However, public routes (login, marketing pages) could benefit from Server Components.

#### 4. Legacy Import Pattern (Acceptable)

```tsx
import * as React from "react";  // Still valid in React 19
```

This is still needed for `React.forwardRef`, `React.memo`, `React.createContext`.

---

## Drizzle ORM

**Version:** 0.44.7

### ‚úÖ Well Configured

The Drizzle setup is largely correct for Cloudflare Workers:

- Per-request DB instance creation is appropriate for serverless
- Relational query pattern (`db.query.*.findMany()`) is well-used
- Transaction patterns are correctly implemented

### Minor Considerations

#### 1. Connection Pooling

Monitor connection usage under load. The per-request `new Pool()` pattern works but has overhead. Consider Neon's serverless driver optimizations if this becomes a bottleneck.

---

## Better-Auth

**Version:** 1.4.3

### Issues Found

#### 1. Auth Instance Created Per Request

**Issue:** New Better-Auth instance created for every request.

```typescript
// apps/os2/backend/worker.ts
app.use("*", async (c, next) => {
  const db = getDb();
  const auth = getAuth(db);  // ‚ùå New instance per request
  // ...
});
```

**Potential Problems:**
- Performance overhead from plugin initialization
- Memory churn in serverless environment

**Research Needed:** Verify if Better-Auth v1.4+ recommends singleton pattern for Cloudflare Workers.

#### 2. No Rate Limiting on Auth Endpoints

**Issue:** Auth endpoints vulnerable to brute force attacks.

**Recommendation:** Implement rate limiting using Cloudflare Workers KV or Durable Objects for:
- Login attempts (per IP, per email)
- OTP generation/verification
- Password reset requests

#### 3. Email OTP Not Actually Sending

**Issue:**
```typescript
// apps/os2/backend/auth/auth.ts
sendVerificationOTP: async ({ email, otp }) => {
  console.log(`[EMAIL OTP] Would send OTP ${otp} to ${email}`);
  // TODO: Implement actual email sending
}
```

**Recommendation:** Implement actual email sending (Resend, SendGrid, AWS SES).

#### 4. Missing Cookie Security Configuration

**Issue:** No explicit configuration for cookie security (sameSite, secure, httpOnly).

**Recommendation:** Explicitly configure:
```typescript
session: {
  cookie: {
    secure: true,      // Production only
    httpOnly: true,
    sameSite: "lax",
  },
}
```

---

## Hono

**Version:** 4.10.7

### ‚úÖ Well Configured

The Hono setup follows best practices:

- Middleware order is correct (contextStorage ‚Üí cors/secureHeaders ‚Üí app middleware)
- WorkerEntrypoint pattern is appropriate
- contextStorage() usage is correct
- Error handling is solid

### Minor Note

The `contextStorage()` middleware adds slight overhead. Since you're already using `c.var` for request-scoped values, consider if contextStorage() is truly needed.

---

## Zod v4

**Version:** 4.1.12

### ‚úÖ Well Configured

- Error formatting with `prettifyError()` is excellent
- tRPC integration is solid
- Proper separation of form-level vs field-level errors

### Documentation Fix Needed

Update `vibe-rules/rules/typescript.md` to clarify that `import { z } from "zod/v4"` is only needed when multiple Zod versions are installed.

---

## Cloudflare Workers

**Version:** Wrangler 4.51.0

### Issues Found

#### 1. `console.log` Usage

**Rule Violation:** CLAUDE.md states backend should use `logger` from `tag-logger.ts`, not `console`.

**Current:**
```typescript
// apps/os2/backend/worker.ts:64
console.log("Request:", requestTags);
```

**Recommendation:** Use structured logging via tag-logger pattern from apps/os.

#### 2. Per-Request Database Connection

This is acceptable for serverless but monitor for performance issues under high load.

---

## Vite & Tailwind CSS v4

**Versions:** Vite 7.2.4, Tailwind CSS 4.1.17

### Issues Found

#### 1. `mangle: false` in Terser Config

**Issue:** Disabling mangling increases bundle size by ~10-15%.

**Current:**
```typescript
build: {
  minify: "terser",
  terserOptions: {
    mangle: false,  // ‚ùå Unnecessarily increases bundle size
  },
}
```

**Recommended:**
```typescript
build: {
  sourcemap: true,  // Keep sourcemaps for debugging
  minify: "terser",
  terserOptions: {
    mangle: true,   // ‚úÖ Enable mangling
    compress: {
      drop_console: true,  // Remove debug logs
    },
  },
}
```

---

## Summary & Prioritized Action Items

### üî¥ Critical (Fix Immediately)

| # | Issue | Impact | Effort |
|---|-------|--------|--------|
| 1 | Convert `useQuery` ‚Üí `useSuspenseQuery` | Violates own rules, poor UX | Medium (2-3 hours) |
| 2 | Add Suspense boundaries | Required for React 19 patterns | Low (1 hour) |
| 3 | Add Error boundaries | No graceful error handling | Low (1 hour) |
| 4 | Move auth checks to `beforeLoad` | Unnecessary renders | Medium (1-2 hours) |

### üü° High Priority (Fix Soon)

| # | Issue | Impact | Effort |
|---|-------|--------|--------|
| 5 | Add route loaders for data fetching | No SSR/prefetching | High (4-6 hours) |
| 6 | Fix QueryClient singleton for SSR | SSR hydration issues | Low (30 min) |
| 7 | Add `maxURLLength` to httpBatchLink | Large requests fail | Very Low (5 min) |
| 8 | Replace `<Navigate>` with `throw redirect()` | Performance | Low (1 hour) |
| 9 | Implement rate limiting for auth | Security vulnerability | Medium (2-3 hours) |
| 10 | Enable terser mangling | 10-15% larger bundles | Very Low (5 min) |

### üü¢ Medium Priority (Backlog)

| # | Issue | Impact | Effort |
|---|-------|--------|--------|
| 11 | Fix hardcoded query key invalidations | Stale data possible | Low (1 hour) |
| 12 | Pass QueryClient to router context | Loaders can't prefetch | Low (30 min) |
| 13 | Implement actual email OTP sending | Feature incomplete | Medium (2-3 hours) |
| 14 | Add cookie security config | Security best practice | Low (30 min) |
| 15 | Replace console.log with logger | Violates own rules | Low (30 min) |

### üìù Documentation Updates

| # | Issue | Location |
|---|-------|----------|
| 16 | Update Zod import rule | `vibe-rules/rules/typescript.md` |
| 17 | Document auth instance pattern | `apps/os2/backend/auth/auth.ts` |

---

## Migration Checklist

```
[ ] 1. Add ErrorBoundary component
[ ] 2. Wrap root with ErrorBoundary
[ ] 3. Add `wrapInSuspense: true` to root route
[ ] 4. Convert all `useQuery` to `useSuspenseQuery` (16+ files)
[ ] 5. Remove manual loading states from components
[ ] 6. Add Suspense fallbacks to layout components
[ ] 7. Move auth checks to `beforeLoad`
[ ] 8. Replace `<Navigate>` with `throw redirect()`
[ ] 9. Update QueryClient creation for SSR
[ ] 10. Add route loaders for data fetching
[ ] 11. Pass QueryClient through router context
[ ] 12. Fix hardcoded query key invalidations
[ ] 13. Add maxURLLength to httpBatchLink
[ ] 14. Add retry and gcTime to QueryClient config
[ ] 15. Enable terser mangling
[ ] 16. Implement rate limiting for auth
[ ] 17. Replace console.log with logger
[ ] 18. Update Zod import documentation

Total Estimated Effort: 15-25 hours
```

---

*This analysis was generated by thoroughly researching current documentation (2025-2026) for all major technologies used in the codebase.*

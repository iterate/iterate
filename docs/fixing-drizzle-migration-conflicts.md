# Fixing Drizzle Migration Merge Conflicts

When multiple branches add migrations, merge conflicts can occur. This guide covers how to resolve them.

> **NEVER manually edit `_journal.json` or `*_snapshot.json` files.** These are generated by `drizzle-kit` and must only be modified through its CLI. Manual edits cause subtle ordering/consistency bugs that are hard to diagnose.

## How Drizzle Migrations Work

Drizzle stores migrations in:

- `<migrations-dir>/*.sql` — actual SQL migration files
- `<migrations-dir>/meta/_journal.json` — tracks migration order and tags
- `<migrations-dir>/meta/*_snapshot.json` — schema state snapshots

The journal and snapshots are managed exclusively by `drizzle-kit generate`. The journal tracks ordering via timestamps; if these get out of order (e.g. from a bad merge), migrations silently fail to apply.

Multiple packages have their own migrations (e.g. `apps/os/backend/db/migrations/`, `apps/daemon/drizzle/`). The same process applies to all of them.

## Common Conflict Scenarios

### 1. Same Migration Index on Both Branches

Both branches generate a new migration (e.g., `0005_*.sql`) independently:

```
main:     0005_feature_a.sql
branch:   0005_feature_b.sql
```

### 2. Journal File Conflicts

The `_journal.json` has conflicting entries from both branches.

### 3. Tag Mismatch

Journal references a file that doesn't exist (wrong tag name).

## Resolution Steps

### Step 1: Reset all meta files to main

Reset the journal **and all snapshot files** to main's versions:

```bash
git checkout main -- <migrations-dir>/meta/
```

### Step 2: Delete your branch's migration files

Remove only the SQL files your branch added (not main's):

```bash
rm <migrations-dir>/XXXX_your_migration.sql
```

### Step 3: Regenerate migration

From the package directory, regenerate. `drizzle-kit` will diff your schema against the last snapshot from main and produce the correct SQL, journal entry, and snapshot:

```bash
pnpm drizzle-kit generate --name your_migration_name
```

This creates a new migration with the correct next index, timestamp, journal entry, and snapshot. It may ask interactive questions (e.g. "is this column created or renamed?") — answer them.

### Step 4: Verify

```bash
pnpm drizzle-kit check
```

This verifies migration consistency. Fix any reported issues.

### Step 5: Test on a fresh DB

```bash
rm -f /tmp/test.sqlite
DATABASE_URL=/tmp/test.sqlite pnpm drizzle-kit migrate
sqlite3 /tmp/test.sqlite ".schema"
```

Confirm the resulting schema matches what your code expects.

## Preventing Conflicts

1. **Coordinate migration timing** — avoid parallel schema changes when possible
2. **Rebase frequently** — keep branches up to date with main
3. **Generate migrations late** — delay `drizzle-kit generate` until ready to merge
4. **Use named migrations** — `drizzle-kit generate --name descriptive_name` makes conflicts easier to understand

## Debugging Tips

### Check for Missing Files

```bash
# List all SQL migrations
ls <migrations-dir>/*.sql

# Check journal entries
cat <migrations-dir>/meta/_journal.json | jq '.entries[].tag'
```

### Verify Tags Match Files

Every `tag` in the journal must have a corresponding `.sql` file:

- Journal tag: `0005_billing_account`
- File must exist: `0005_billing_account.sql`

### Missing Snapshots

Snapshots are only needed for generating new migrations, not for running them. If you're missing a snapshot but have the SQL file, migrations will still run.

## References

- [Drizzle Kit Check](https://orm.drizzle.team/docs/drizzle-kit-check) — verify migration consistency
- [Drizzle Migrations](https://orm.drizzle.team/docs/migrations) — migration overview
- [GitHub Discussion #1104](https://github.com/drizzle-team/drizzle-orm/discussions/1104) — community discussion on merge conflicts

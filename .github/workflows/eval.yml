# this file is generated by eval.ts, do not edit it manually

name: run evals
on:
  push:
    branches:
      - "*eval*"
  workflow_dispatch: {}
permissions:
  contents: read
  deployments: write
env:
  DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
jobs:
  run:
    runs-on: ${{ github.repository_owner == 'iterate' && 'depot-ubuntu-24.04-arm-4' || 'ubuntu-24.04' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
      - run: pnpm install
      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v2
      - name: Setup Doppler
        run: doppler setup --config dev --project os
      - name: run dependencies
        run: pnpm docker:up
      - name: migrate db
        uses: nick-fields/retry@v3
        with:
          timeout_seconds: 30
          max_attempts: 10
          retry_wait_seconds: 5
          command: pnpm db:migrate
      - name: get rid of ngrok
        run: rm packages/ngrok/package.json
      - name: simplify sandbox Dockerfile
        run: |-
          # For some reason the nodejs v24 installation in the Dockerfile fails in CI, but the built-in version of nodejs works for these purposes
          echo '
          FROM docker.io/cloudflare/sandbox:0.3.2
          EXPOSE 3000
          ' > apps/os/backend/sandbox/Dockerfile
      - name: run preview server
        id: preview_server
        run: |-
          # for some reason `doppler run -- ...` doesn't inject env vars into the server process, so write to .env

          cd apps/os

          echo '
            import * as fs from "fs";
            const waitFor = process.argv[2];
            const timeoutSeconds = Number(process.argv[3]);

            for (let i = 0; i < timeoutSeconds; i++) {
              if (fs.existsSync(waitFor)) {
                console.log(`${waitFor} exists`);
                return;
              }
              await new Promise(resolve => setTimeout(resolve, 1000));
              console.log(`${waitFor} not found yet, retrying ${i + 1}/${timeoutSeconds}`);
            }
            throw new Error(`${waitFor} not found after ${timeoutSeconds} seconds`);
          ' > wait-for-file.mjs

          echo '
            const main = async () => {
              const waitFor = process.argv[2];
              const timeoutSeconds = Number(process.argv[3]);
              for (let i = 0; i < timeoutSeconds; i++) {
                try {
                  const res = await fetch(waitFor);
                  if (!res.ok) throw new Error(`${waitFor} not ready`);
                  console.log(`${waitFor} ready`);
                  return;
                } catch (error) {
                  console.log(`${waitFor} not ready, retrying ${i + 1}/${timeoutSeconds}`);
                  await new Promise(resolve => setTimeout(resolve, 1000));
                }
              }
              throw new Error(`${waitFor} not ready after ${timeoutSeconds} seconds`);
            }
            await main();
          ' > wait-for-url.mjs

          doppler run -- printenv >> .env
          echo SLACK_CLIENT_ID=fake >> .env

          SLACK_CLIENT_ID=fake doppler run -- pnpm dev &
          DEV_PID=$!

          echo "Waiting for wrangler.jsonc to be created"

          node wait-for-file.mjs "$(pwd)/.alchemy/local/wrangler.jsonc" 240
          echo "Wrangler.jsonc created, killing dev process"
          kill -9 $DEV_PID

          echo "Starting preview server"

          SLACK_CLIENT_ID=fake doppler run -- pnpm preview &

          echo "Waiting for preview server to be ready"

          node wait-for-url.mjs "http://localhost:5173" 240

          echo "Preview server ready"
      - name: run the tests
        run: |-
          cd apps/os
          # finally, run the tests
          export PROJECT_NAME=gh-evals-${{ github.head_ref || github.ref_name }}
          doppler run -- pnpm evalite export --output ignoreme/evalite-ui
      - name: upload evalite ui
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: evalite
          path: apps/os/ignoreme/evalite-ui
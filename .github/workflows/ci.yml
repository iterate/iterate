# this file is generated by ci.ts, do not edit it manually

name: CI
permissions:
  contents: read
  deployments: write
  id-token: write
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      stage:
        description: The stage to deploy to. Must correspond to a Doppler config in the os project (prd, stg, dev, dev_bob etc.).
        required: false
        type: string
jobs:
  variables:
    runs-on: ubuntu-24.04
    steps:
      - id: get_env
        name: Get environment variables
        run: echo stage=${{ inputs.stage || 'prd' }} >> $GITHUB_OUTPUT
    outputs:
      stage: ${{ steps.get_env.outputs.stage }}
  push-daytona-snapshot:
    needs:
      - variables
    if: needs.variables.outputs.stage == 'prd'
    uses: ./.github/workflows/push-daytona-snapshot.yml
    secrets: inherit
    with:
      doppler_config: prd
      build_image: true
      docker_platform: linux/amd64
      update_fly_doppler: true
      fly_doppler_configs_to_update: dev,stg,prd
      update_doppler: true
  deploy:
    uses: ./.github/workflows/deploy.yml
    needs:
      - variables
      - push-daytona-snapshot
    if: needs.variables.outputs.stage == 'prd'
    secrets: inherit
    with:
      stage: ${{ needs.variables.outputs.stage }}
      daytona_snapshot_name: ${{ needs.push-daytona-snapshot.outputs.snapshot_name }}
  slack_failure:
    needs:
      - variables
      - push-daytona-snapshot
      - deploy
    if: always() && contains(needs.*.result, 'failure')
    runs-on: ubuntu-24.04
    env:
      NEEDS: ${{ toJson(needs) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
      - name: Install dependencies
        run: pnpm install
      - name: notify_slack_on_failure
        id: notify_slack_on_failure
        uses: actions/github-script@v7
        with:
          script: |-
            github.log = {
              ...console,
              debug: () => {},
            };

            // write a shimmed module of "../utils/slack.ts" that actions/github-script can require (see https://github.com/actions/github-script?tab=readme-ov-file#this-action)
            require("fs").writeFileSync(
              ".github/ts-workflows/workflows/ci.ts.utilsslackts-64e60416ee9563c2f22509a2a7a4ac68-tsx-shim.cjs",
              "module.exports.load = () => require(\"tsx/esm/api\").tsImport(\"../utils/slack.ts\", __filename);",
            );

            const vars = {
              github,
              context,
              core,
              glob,
              io,
              require,
            };

            const __handler = async function notify_slack_on_failure() {
              const {
                getSlackClient,
                slackChannelIds,
              } = await require(
                ".github/ts-workflows/workflows/ci.ts.utilsslackts-64e60416ee9563c2f22509a2a7a4ac68-tsx-shim.cjs" /* <-- shimmed module of "../utils/slack.ts" that actions/github-script can require */,
              ).load();

              const slack = getSlackClient("${{ secrets.SLACK_CI_BOT_TOKEN }}");
              const needs = JSON.parse(process.env.NEEDS);

              const failedJobs = Object.entries(needs).filter((
                [_, {
                  result,
                }],
              ) => result === "failure").map(([name]) => name);

              const outputs = needs.variables?.outputs;
              const outputsString = new URLSearchParams(outputs).toString().replaceAll("&", ", ");
              let message = `ðŸš¨ ${failedJobs.join(", ")} failed on \${{ github.ref_name }}. ${outputsString}.`;
              message += " <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>";

              await slack.chat.postMessage({
                channel: slackChannelIds["#error-pulse"],
                text: message,
              });
            };

            return __handler(vars);
# this file is generated by ci.ts, do not edit it manually

name: CI
permissions:
  contents: read
  deployments: write
on:
  push:
    branches:
      - main
      - mmkal/25/10/28/runonboardingagainststaging
  workflow_dispatch:
    inputs:
      stage:
        description: The stage to deploy to. Must correspond to a Doppler config in the os project (prd, stg, dev, dev_bob etc.).
        required: true
        type: string
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false
jobs:
  variables:
    runs-on: ${{ github.repository_owner == 'iterate' && 'depot-ubuntu-24.04-arm-4' || 'ubuntu-24.04' }}
    steps:
      - id: get_env
        name: Get environment variables
        run: echo \"stage=${{ inputs.stage || 'stg' }}\" >> $GITHUB_OUTPUT
    outputs:
      stage: ${{ steps.get_env.outputs.stage }}
  deploy:
    uses: ./.github/workflows/deploy.yml
    needs:
      - variables
    secrets: inherit
    with:
      stage: ${{ needs.variables.outputs.stage }}
  onboarding_monitor:
    if: needs.variables.outputs.stage == 'prd' || needs.variables.outputs.stage == 'stg'
    uses: ./.github/workflows/onboarding-monitor.yml
    secrets: inherit
    needs:
      - variables
      - deploy
    with:
      worker_url: ${{ needs.deploy.outputs.worker_url || 'some_garbage' }}
      stage: ${{ needs.variables.outputs.stage }}
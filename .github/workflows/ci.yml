# this file is generated by ci.ts, do not edit it manually

name: CI
permissions:
  contents: read
  deployments: write
  id-token: write
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      stage:
        description: The stage to deploy to. Must correspond to a Doppler config in the os project (prd, stg, dev, dev_bob etc.).
        required: false
        type: string
jobs:
  variables:
    runs-on: ubuntu-24.04
    steps:
      - id: get_env
        name: Get environment variables
        run: echo stage=${{ inputs.stage || 'prd' }} >> $GITHUB_OUTPUT
      - name: Document rollout strategy
        run: |-
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## Rollout Strategy
          1. Deploy OS worker quickly with current environment variables.
          2. Build new sandbox image.
          3. Run Fly sandbox tests against the new image.
          4. If tests pass, update Doppler FLY_DEFAULT_IMAGE and deploy OS worker again.
          EOF
    outputs:
      stage: ${{ steps.get_env.outputs.stage }}
  deploy-os-early:
    uses: ./.github/workflows/deploy.yml
    needs:
      - variables
    if: needs.variables.outputs.stage == 'prd'
    secrets: inherit
    with:
      stage: ${{ needs.variables.outputs.stage }}
      deploy_iterate_com: false
  build-sandbox-image:
    uses: ./.github/workflows/build-sandbox-image.yml
    needs:
      - variables
      - deploy-os-early
    if: needs.variables.outputs.stage == 'prd'
    secrets: inherit
    with:
      doppler_config: prd
      docker_platform: linux/amd64
      skip_load: false
      update_doppler: false
  test-sandbox-fly:
    needs:
      - variables
      - build-sandbox-image
    if: needs.variables.outputs.stage == 'prd'
    uses: ./.github/workflows/sandbox-test-fly.yml
    secrets: inherit
    with:
      doppler_config: prd
      fly_image_tag: ${{ needs.build-sandbox-image.outputs.fly_image_tag }}
  promote-fly-default-image:
    needs:
      - variables
      - build-sandbox-image
      - test-sandbox-fly
    if: needs.variables.outputs.stage == 'prd'
    runs-on: ubuntu-24.04
    steps:
      - name: Install Doppler CLI
        run: |-
          for i in 1 2 3; do curl -sfLS https://cli.doppler.com/install.sh | sh -s -- --no-package-manager && break; echo "Attempt $i failed, retrying in 5s..."; sleep 5; done
          doppler --version || { echo 'Failed to install Doppler CLI after 3 attempts'; exit 1; }
      - name: Setup Doppler
        run: doppler setup --config prd --project os
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
      - name: Update Doppler FLY_DEFAULT_IMAGE
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          FLY_IMAGE_TAG: ${{ needs.build-sandbox-image.outputs.fly_image_tag }}
        run: |-
          set -euo pipefail
          echo "Promoting FLY_DEFAULT_IMAGE=${FLY_IMAGE_TAG} to dev/stg/prd"
          for cfg in dev stg prd; do
            doppler secrets set FLY_DEFAULT_IMAGE="${FLY_IMAGE_TAG}" --project os --config "${cfg}"
          done
  deploy:
    uses: ./.github/workflows/deploy.yml
    needs:
      - variables
      - deploy-os-early
      - build-sandbox-image
      - test-sandbox-fly
      - promote-fly-default-image
    if: needs.variables.outputs.stage == 'prd'
    secrets: inherit
    with:
      stage: ${{ needs.variables.outputs.stage }}
  slack_failure:
    needs:
      - variables
      - deploy-os-early
      - build-sandbox-image
      - test-sandbox-fly
      - promote-fly-default-image
      - deploy
    if: always() && contains(needs.*.result, 'failure')
    runs-on: ubuntu-24.04
    env:
      NEEDS: ${{ toJson(needs) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
      - name: Install dependencies
        run: pnpm install
      - name: notify_slack_on_failure
        id: notify_slack_on_failure
        uses: actions/github-script@v7
        with:
          script: |-
            github.log = {
              ...console,
              debug: () => {},
            };

            // write a shimmed module of "../utils/slack.ts" that actions/github-script can require (see https://github.com/actions/github-script?tab=readme-ov-file#this-action)
            require("fs").writeFileSync(
              ".github/ts-workflows/workflows/ci.ts.utilsslackts-64e60416ee9563c2f22509a2a7a4ac68-tsx-shim.cjs",
              "module.exports.load = () => require(\"tsx/esm/api\").tsImport(\"../utils/slack.ts\", __filename);",
            );

            const vars = {
              github,
              context,
              core,
              glob,
              io,
              require,
            };

            const __handler = async function notify_slack_on_failure() {
              const {
                getSlackClient,
                slackChannelIds,
              } = await require(
                ".github/ts-workflows/workflows/ci.ts.utilsslackts-64e60416ee9563c2f22509a2a7a4ac68-tsx-shim.cjs" /* <-- shimmed module of "../utils/slack.ts" that actions/github-script can require */,
              ).load();

              const slack = getSlackClient("${{ secrets.SLACK_CI_BOT_TOKEN }}");
              const needs = JSON.parse(process.env.NEEDS);

              const failedJobs = Object.entries(needs).filter((
                [_, {
                  result,
                }],
              ) => result === "failure").map(([name]) => name);

              const outputs = needs.variables?.outputs;
              const outputsString = new URLSearchParams(outputs).toString().replaceAll("&", ", ");
              let message = `ðŸš¨ ${failedJobs.join(", ")} failed on \${{ github.ref_name }}. ${outputsString}.`;
              message += " <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>";

              await slack.chat.postMessage({
                channel: slackChannelIds["#error-pulse"],
                text: message,
              });
            };

            return __handler(vars);
# this file is generated by push-staging-estate.ts, do not edit it manually

name: Push staging estate
on:
  schedule:
    - cron: 0 4 * * *
  push:
    paths:
      - .github/workflows/push-staging-estate.yml
      - .github/ts-workflows/workflows/push-staging-estate.ts
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          path: source-branch
      - name: Checkout staging-estate branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ITERATE_BOT_GITHUB_TOKEN }}
          ref: staging-estate
          path: staging-estate
      - name: Replace estate folder with contents from source-branch
        run: |-
          rm -rf staging-estate/estates/iterate
          mkdir -p staging-estate/estates
          cp -r source-branch/estates/iterate staging-estate/estates/iterate
          rm -rf staging-estate/estates/iterate/apps

          source_branch_sha=$(cd source-branch && git log --pretty=format:'%h' -n 1)
          echo "Using commit hash: $source_branch_sha"

          # Replace workspace:* with pkg.pr.new URL
          sed -i "s|\"@iterate-com/sdk\": \"workspace:\*\"|\"@iterate-com/sdk\": \"https://pkg.pr.new/iterate/iterate/@iterate-com/sdk@$source_branch_sha\"|g" staging-estate/estates/iterate/package.json
      - name: Commit and push
        working-directory: staging-estate
        run: |-
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git diff --exit-code || {
            git add .
            git commit -m "update staging estate"
            git push
          }

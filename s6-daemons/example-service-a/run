#!/bin/sh
exec 2>&1
cd "$ITERATE_REPO/scripts"

# Set up FIFO for health check notification (unique per PID to avoid conflicts)
NOTIFY_FIFO="/tmp/s6-notify-service-a-$$"
mkfifo "$NOTIFY_FIFO"

# Health checker polls endpoint, writes to FIFO when ready
"$ITERATE_REPO/scripts/s6-healthcheck-notify.sh" http://localhost:3001/health "$NOTIFY_FIFO" &

# Duplicate fd 3 to fd 4 so background job can use it
# (background jobs may not inherit fd 3 directly in some shells)
exec 4>&3

# Waiter: reads FIFO (blocks until health check writes), then notifies s6 via fd 4
{
  if read -r _ < "$NOTIFY_FIFO" 2>/dev/null; then
    printf '\n' >&4 2>/dev/null && echo "s6 notified via fd 4 (dup of 3)"
  fi
  rm -f "$NOTIFY_FIFO"
} &

# Example service A: slow-starting service (2 second delay)
# Service B depends on this service
exec node --experimental-strip-types test-daemon.ts \
  --name service-a \
  --port 3001 \
  --startup-delay 2000

#!/bin/sh
exec 2>&1
cd "$ITERATE_REPO/scripts"

# Set up FIFO for health check notification
NOTIFY_FIFO="/tmp/s6-notify-service-b-$$"
mkfifo "$NOTIFY_FIFO"

# Health checker polls endpoint, writes to FIFO when ready
"$ITERATE_REPO/scripts/s6-healthcheck-notify.sh" http://localhost:3002/health "$NOTIFY_FIFO" &

# Duplicate fd 3 to fd 4 so background job can use it
exec 4>&3

# Waiter: reads FIFO, then notifies s6 via fd 4
{
  if read -r _ < "$NOTIFY_FIFO" 2>/dev/null; then
    printf '\n' >&4 2>/dev/null && echo "s6 notified via fd 4 (dup of 3)"
  fi
  rm -f "$NOTIFY_FIFO"
} &

# Example service B: depends on service A
# Health check will fail until service A is ready (checks A's /ping endpoint)
exec node --experimental-strip-types test-daemon.ts \
  --name service-b \
  --port 3002 \
  --startup-delay 0 \
  --upstream http://localhost:3001/ping

services:
  egress-proxy:
    build:
      context: .
      dockerfile: docker/egress.Dockerfile
    environment:
      EGRESS_MITM_PORT: "18080"
      EGRESS_VIEWER_PORT: "18081"
      PROXIFY_CONFIG_DIR: /data/mitm
      EGRESS_LOG_PATH: /tmp/egress-proxy.log
      EGRESS_DATA_DIR: /data
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-}"
    volumes:
      - fly-test-mitm-data:/data/mitm
      - fly-test-egress-data:/data
    ports:
      - "${EGRESS_VIEWER_HOST_PORT:-0}:18081"

  sandbox-ui:
    build:
      context: .
      dockerfile: docker/sandbox.Dockerfile
    environment:
      SANDBOX_PORT: "8080"
      EGRESS_PROXY_HOST: "egress-proxy"
      EGRESS_MITM_PORT: "18080"
      DEFAULT_TARGET_URL: "${TARGET_URL:-https://example.com/}"
      WS_PROXY_URL: "ws://egress-proxy:18081/api/ws/proxy"
      WS_UPSTREAM_URL: "wss://ws.ifelse.io"
    depends_on:
      - egress-proxy
    ports:
      - "${SANDBOX_HOST_PORT:-0}:8080"

volumes:
  fly-test-mitm-data:
  fly-test-egress-data:

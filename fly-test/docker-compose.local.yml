services:
  ws-upstream:
    build:
      context: .
      dockerfile: docker/ws-upstream.Dockerfile
    environment:
      UPSTREAM_WS_PORT: "19090"
      UPSTREAM_WS_LOG_PATH: /tmp/ws-upstream.log
    ports:
      - "${WS_UPSTREAM_HOST_PORT:-0}:19090"

  egress-proxy:
    build:
      context: .
      dockerfile: docker/egress.Dockerfile
    environment:
      EGRESS_MITM_PORT: "18080"
      EGRESS_VIEWER_PORT: "18081"
      PROXIFY_CONFIG_DIR: /data/mitm
      EGRESS_LOG_PATH: /tmp/egress-proxy.log
    volumes:
      - fly-test-mitm-data:/data/mitm
    ports:
      - "${EGRESS_VIEWER_HOST_PORT:-0}:18081"

  sandbox-ui:
    build:
      context: .
      dockerfile: docker/sandbox.Dockerfile
    environment:
      SANDBOX_PORT: "8080"
      EGRESS_PROXY_HOST: "egress-proxy"
      EGRESS_MITM_PORT: "18080"
      DEFAULT_TARGET_URL: "${TARGET_URL:-https://example.com/}"
      WS_PROXY_URL: "ws://egress-proxy:18081/api/ws/proxy"
      WS_UPSTREAM_URL: "ws://ws-upstream:19090/ws"
    depends_on:
      - ws-upstream
      - egress-proxy
    ports:
      - "${SANDBOX_HOST_PORT:-0}:8080"

volumes:
  fly-test-mitm-data:
